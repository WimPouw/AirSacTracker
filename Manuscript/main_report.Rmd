---
title: "Dynamic Circular Tracking in Animal Behaviors Using Hough Transfomations"
author: "Lara S. Burchardt & Wim Pouw"
date: "2022-12-14"
output:
  html_document:
    df_print: paged
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, collapse = TRUE, message = FALSE, echo = FALSE}

library(tidyverse)
library(effsize)
library(psych)
library(signal)
library(knitr)

butter.it <- function(x, samplingrate, order, lowpasscutoff)
{bf <- butter(order,lowpasscutoff/samplingrate, type="low") #normalized frequency
x <<- as.numeric(signal::filtfilt(bf, x))} 

```


# Settings

We compare the manully tracked radii with the automatically tracked radii for 
different parameter settings. 
The following parameters are varied: 

alphas = [2, 2.5, 3]
betas = [25,30,35] 
dilations = [5,6,7] 
medianblurs = [25, 27, 29]  
threshs_div_1 = [8,10,12]
threshs_div_2 = [13,15,17]

The python codes can be found here:
https://github.com/WimPouw/AirSacTracker/blob/main/Script/AirSacTracking_cleaned_larawimv2.ipynb 

```{r processing_1, message = FALSE, echo = FALSE}

man_data <- read_delim("manual_results_circular_tracking_deleted_duplicate_second_version.csv", delim = ";")

#add transformation from perimeter to radius in manual data
man_data$...6 <- man_data$Perim./(2*pi)
names(man_data)[names(man_data) == "...6"] <- "radius_man"
names(man_data)[names(man_data) == "Label"] <- "name"


# set path for comparison
path <- "AirSacTracker/TestResults"
pattern <- "csv"
list_of_files <- list.files(path = path, pattern = pattern)

# set up results dataframe

df <- data.frame()

for (a in 1:length(list_of_files)) {
  
auto_data <- read_delim(paste(path, list_of_files[a], sep = "\\"), delim = "," )

#getting videoname
videoname <- list_of_files[a]
videoname <- substring(videoname, 1, nchar(videoname)-4)
videoname <- str_split(videoname, pattern = "_")
videoname <- videoname[[1]]
videoname <- paste(videoname[14], videoname[15], sep = "_")

smoothed_auto <- as.data.frame(
                  butter.it(auto_data$r, samplingrate =  25, order = 2, lowpasscutoff = 5))

auto_data <- auto_data %>% 
  mutate(smoothed_r = smoothed_auto[1:nrow(smoothed_auto), 1])

# joining datasets
joined_data <- left_join(auto_data, man_data, by = "name")

# removing all lines, where no circle was tracked manually

joined_data <- joined_data %>% 
  dplyr::filter(radius_man > 100 | !is.na(radius_man)) %>% 
  dplyr::filter(r < 250)

# run correlation

cor_r <- corr.test(joined_data$r, joined_data$radius_man)
cor_r_sm <- corr.test(joined_data$smoothed_r, joined_data$radius_man)
cor_x <- corr.test(joined_data$x, joined_data$X)
cor_y <- corr.test(joined_data$y, joined_data$Y)

# difference in tracking
diff <- c()
diff_sqr <- c() 
for (c in 1: nrow(joined_data)){
  
  diff[c] <- round(joined_data$r[c] - joined_data$radius_man[c], digits = 2)
  diff_sqr[c] <- diff[c]^2
  
}

diff_min <- min(abs(diff))
diff_max <- max(abs(diff))
diff_avg <- mean(abs(diff))
diff_median <- median(abs(diff))

diff_sqr_min <- min(abs(diff_sqr))
diff_sqr_max <- max(abs(diff_sqr))
diff_sqr_avg <- mean(abs(diff_sqr))
diff_sqr_median <- median(abs(diff_sqr))

# save relevant parameters 
# what do we need to save? 
# video name, correlation, preprocessing parameters, how many frames in correlation from how many in the video

df[a,1] <- videoname
df[a,2] <- cor_r$r
df[a,3] <- cor_r_sm$r
df[a,4] <- cor_x$r
df[a,5] <- cor_y$r
df[a,6] <- nrow(joined_data)
df[a,7] <- nrow(auto_data)
df[a,8] <- joined_data$alpha[1]
df[a,9] <- joined_data$beta[1]
df[a,10] <- joined_data$threh_div1[1]
df[a,11] <- joined_data$threh_div2[1]
df[a,12] <- joined_data$dilation[1]
df[a,13] <- joined_data$medianblur[1]
df[a,14] <- diff_min 
df[a,15] <- diff_max
df[a,16] <- diff_avg 
df[a,17] <- diff_median
df[a,18] <- diff_sqr_min 
df[a,19] <- diff_sqr_max
df[a,20] <- diff_sqr_avg
df[a,21] <- diff_sqr_median 


}

colnames(df) <- c("videoname", "cor_radius","cor_radius_smoothed", "cor_x",  "cor_y", "nr_frames_used", "nr_frames_in_video",
                               "alpha","beta","thresh_div1","thresh_div2","dilation",
                               "medianblur", "diff_r_min", "diff_r_max","diff_r_avg","diff_r_median","diff_r_sqr_min",
                                "diff_r_sqr_max","diff_r_sqr_avg","diff_r_sqr_median")
```

# Effects of Smoothing

Here we report on the effects of smoothing on the correlation between manually and automatically tracked circles.  

```{r smoothing, echo=FALSE}
best_combos_low_10 <- df %>% 
  group_by(alpha, beta, thresh_div1, thresh_div2, dilation, medianblur) %>%                         summarise(mean_cor = mean(cor_radius_smoothed), median_cor = median(cor_radius_smoothed),
            min_cor = min(cor_radius_smoothed), max_cor = max(cor_radius_smoothed))

knitr::kable(best_combos_low_10)

```


# Best Videos

To check for which videos manual and automatic tracking matched best, 
we summarize correlation values per video. The results are shown in the table below.


```{r best_videos, echo=FALSE}
best_combos_low_10_video <- df %>% 
  group_by(videoname) %>%                            # multiple group columns
  summarise(mean_cor = mean(cor_radius_smoothed), median_cor = median(cor_radius_smoothed),
            min_cor = min(cor_radius_smoothed), max_cor = max(cor_radius_smoothed)) 

knitr::kable(best_combos_low_10_video)

```




# Proof of Concept: Acoustic Analysis

We want to analyse some acoustic parameters of the boom call and song to the inflation of the airsacs.

To Dos:
- preparing Video and Audio files (Wim)
- extracting acoustic parameters
- analysing relation between acoustic parameters and airsack inflation



# Literature to check or include

1. Vocal size exaggeration may have contributed to the origins of vocalic complexity, https://doi.org/10.1098/rstb.2020.0401 
2.  Vocal tract length and formant frequency dispersion correlate with body size in rhesus macaques
W. T.  Fitch, DOI: 10.1121/1.421048
